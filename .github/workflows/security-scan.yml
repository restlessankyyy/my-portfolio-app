name: ðŸ›¡ï¸ Scheduled Security Scan

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - secrets

env:
  NODE_VERSION: '18'

permissions:
  contents: read
  security-events: write

jobs:
  dependency-scan:
    name: ðŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'secrets'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ” NPM Audit
        run: |
          echo "## ðŸ“¦ NPM Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json || true
          
          # Parse and display results
          CRITICAL=$(cat audit.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat audit.json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(cat audit.json | jq '.metadata.vulnerabilities.low // 0')
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          
          # Fail if critical vulnerabilities found
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Critical vulnerabilities found!"
            exit 1
          fi

      - name: ðŸ“¤ Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit.json
          retention-days: 90

  secret-scan:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'dependencies'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy-scan:
    name: ðŸ›¡ï¸ Trivy Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: ðŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  infrastructure-scan:
    name: ðŸ—ï¸ Infrastructure Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == ''
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Checkov IaC Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif

      - name: ðŸ“¤ Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan, trivy-scan, infrastructure-scan]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary Report
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ needs.trivy-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.infrastructure-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
