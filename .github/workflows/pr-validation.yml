name: PR Preview and Validation

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

env:
  AWS_REGION: eu-north-1
  NODE_VERSION: '18'

jobs:
  # Quality Checks
  quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "public/**/*.{js,css,html}"
        continue-on-error: true

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check package vulnerabilities
        run: npm audit --audit-level=high
        continue-on-error: true

  # Infrastructure Validation
  terraform-check:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan -no-color
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}

  # Build Test
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test Lambda package build
        run: |
          chmod +x scripts/build-lambda.sh
          ./scripts/build-lambda.sh

      - name: Verify Lambda package
        run: |
          if [ -f "terraform/portfolio-lambda.zip" ]; then
            echo "‚úÖ Lambda package built successfully"
            unzip -l terraform/portfolio-lambda.zip | head -20
          else
            echo "‚ùå Lambda package not found"
            exit 1
          fi

  # PR Comment with Results
  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [quality, terraform-check, build-test]
    if: always()
    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('## PR Validation Results')
            );

            const qualityStatus = '${{ needs.quality.result }}';
            const terraformStatus = '${{ needs.terraform-check.result }}';
            const buildStatus = '${{ needs.build-test.result }}';

            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return '‚úÖ';
                case 'failure': return '‚ùå';
                case 'cancelled': return '‚èπÔ∏è';
                default: return '‚è≥';
              }
            };

            const body = `## PR Validation Results

            | Check | Status | Result |
            |-------|--------|--------|
            | Code Quality & Security | ${getStatusIcon(qualityStatus)} | ${qualityStatus} |
            | Terraform Validation | ${getStatusIcon(terraformStatus)} | ${terraformStatus} |
            | Build Test | ${getStatusIcon(buildStatus)} | ${buildStatus} |

            ### Summary
            ${qualityStatus === 'success' && terraformStatus === 'success' && buildStatus === 'success' 
              ? 'üéâ All checks passed! This PR is ready for review and merge.' 
              : '‚ö†Ô∏è Some checks failed. Please review the details above and fix any issues.'}

            ### Next Steps
            - Once all checks pass and the PR is approved, merging will trigger automatic deployment to production
            - The portfolio will be live at https://ankitraj.cloud after deployment

            ---
            _Validation completed at ${new Date().toISOString()}_`;

            if (botComment) {
              github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }